{% extends 'base.html' %}
{% block content %}
<h1>Utilisateurs</h1>
<form method="get" class="filter-form">
    <label><input type="checkbox" name="bots" value="1" {% if filters.bots == '1' %}checked{% endif %}> Bots</label>
    <label><input type="checkbox" name="ips" value="1" {% if filters.ips == '1' %}checked{% endif %}> IPs</label>
    <label><input type="checkbox" name="blocked" value="1" {% if filters.blocked == '1' %}checked{% endif %}> Bloqués</label>
    <label>Actifs dans les derniers jours: <input type="number" name="active_days" value="{{ filters.active_days or '' }}"></label>
    <label>Article: <input type="text" name="article" value="{{ filters.article or '' }}"></label>
    
    <label>Trier par:
        <select name="sort">
            <option value="contributions" {% if filters.sort == 'contributions' %}selected{% endif %}>Contributions</option>
            <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Plus récent</option>
            <option value="oldest" {% if filters.sort == 'oldest' %}selected{% endif %}>Plus ancien</option>
        </select>
    </label>
    
    <input type="hidden" name="page" value="1">
    <button type="submit">Filtrer</button>
</form>

<!-- Items per page selector -->
<div class="per-page-selector">
    <form method="get" action="">
        {% for key, value in filters.items() %}
            {% if value and key not in ['per_page', 'page'] %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <label for="per_page">Items per page:</label>
        <select name="per_page" onchange="this.form.submit()">
            <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
        </select>
        <input type="hidden" name="page" value="1">
    </form>
</div>

{% if not users %}
    <div class="empty-state">Aucun utilisateur trouvé</div>
{% else %}
    <table>
        <thead>
            <tr><th>ID</th><th>Nom</th><th>IP</th><th>Bot</th><th>Bloqué</th><th>Contributions</th><th>Dernière activité</th></tr>
        </thead>
        <tbody>
        {% for u in users %}
            <tr>
                <td>{{ u['id'] }}</td>
                <td>
                    {% if u['username'] %}
                        <a href="{{ url_for('user_infos', username=u['username']) }}"
                            class="user-link"
                            title="Voir l'utilisateur">
                            {{ u['username'] }}
                        </a>
                    {% else %}
                        <span class="anonymous">Anonyme</span>
                    {% endif %}
                </td>
                <td>{{ '✓' if u['is_ip'] }}</td>
                <td>{{ '✓' if u['is_bot'] }}</td>
                <td>{{ '✓' if u['is_blocked'] }}</td>
                <td>{{ u['contributions'] }}</td>
                <td>{{ u['last_activity'] }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination">
        {% if pagination.page > 1 %}
            <a href="{{ url_for('users_list', page=pagination.page-1, per_page=pagination.per_page, **filters) }}">&laquo; Previous</a>
        {% endif %}
        
        {% for p in range(1, (pagination.total // pagination.per_page + 2)) %}
            {% if p == pagination.page %}
                <span class="current-page">{{ p }}</span>
            {% else %}
                <a href="{{ url_for('users_list', page=p, per_page=pagination.per_page, **filters) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}
        
        {% if pagination.page * pagination.per_page < pagination.total %}
            <a href="{{ url_for('users_list', page=pagination.page+1, per_page=pagination.per_page, **filters) }}">Next &raquo;</a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}